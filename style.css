// script.js — interactions : shape toggle, lightbox, loading handling, download link
document.addEventListener('DOMContentLoaded', () => {
  const photo = document.getElementById('mainPhoto');
  const btnZoom = document.getElementById('btnZoom');
  const btnShape = document.getElementById('btnShape');
  const btnDownload = document.getElementById('btnDownload');
  const skeleton = document.getElementById('photoSkeleton');

  const lightbox = document.getElementById('lightbox');
  const lbImg = document.getElementById('lbImg');
  const lbClose = document.getElementById('lbClose');
  const lbPrev = document.getElementById('lbPrev');
  const lbNext = document.getElementById('lbNext');
  const lbDownload = document.getElementById('lbDownload');

  // Show skeleton while image is loading
  function showSkeleton() { skeleton.style.display = 'block'; }
  function hideSkeleton() { skeleton.style.display = 'none'; }

  // Start with skeleton until image loaded
  if (!photo.complete) showSkeleton();
  photo.addEventListener('load', () => {
    hideSkeleton();
  });
  photo.addEventListener('error', () => {
    hideSkeleton();
    // show textual hint if image not found
    const parent = photo.parentElement;
    const notice = document.createElement('div');
    notice.className = 'img-error';
    notice.textContent = 'Image introuvable — vérifie le chemin/nom dans images/';
    notice.style.color = '#991b1b';
    notice.style.fontWeight = '700';
    notice.style.padding = '8px';
    parent.appendChild(notice);
    photo.style.display = 'none';
  });

  // Restore shape preference
  try {
    const saved = localStorage.getItem('photoRound');
    if (saved === '1') photo.classList.add('round');
  } catch (e) { /* ignore */ }

  // Toggle round / square
  btnShape.addEventListener('click', () => {
    const isRound = photo.classList.toggle('round');
    btnShape.textContent = isRound ? 'Carré' : 'Rond';
    try { localStorage.setItem('photoRound', isRound ? '1' : '0'); } catch {}
  });

  // Lightbox: open and set image
  function openLightbox(src, alt, downloadHref) {
    lbImg.src = src;
    lbImg.alt = alt || '';
    lbDownload.href = downloadHref || src;
    lightbox.classList.add('open');
    lightbox.setAttribute('aria-hidden', 'false');
    document.documentElement.style.overflow = 'hidden';
  }

  function closeLightbox() {
    lightbox.classList.remove('open');
    lightbox.setAttribute('aria-hidden', 'true');
    document.documentElement.style.overflow = '';
    // free memory on mobile
    lbImg.src = '';
  }

  // open by clicking image or zoom button
  photo.addEventListener('click', () => openLightbox(photo.src, photo.alt, btnDownload.href));
  btnZoom.addEventListener('click', () => openLightbox(photo.src, photo.alt, btnDownload.href));

  // lightbox controls
  lbClose.addEventListener('click', closeLightbox);
  lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeLightbox();
  });

  // Download buttons: ensure href points to image
  btnDownload.href = photo.src;
  lbDownload.href = photo.src;

  // Optional: preload a larger image for the lightbox (if you have one)
  // Example assumes images/profile-1600.jpg exists
  const large = 'images/profile-1600.jpg';
  const imgLarge = new Image();
  imgLarge.src = large;
  imgLarge.onload = () => {
    // if loaded successfully, use it for lightbox & download
    // but only if the file exists on the server
    btnDownload.href = large;
    lbDownload.href = large;
  };
});
